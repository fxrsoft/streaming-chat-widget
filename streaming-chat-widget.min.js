!function(e){"use strict";if(!e.DOMPurify)return void console.error("StreamingChatWidget requires DOMPurify. Please include it in your page.");if(!e.marked)return void console.error("StreamingChatWidget requires marked.js. Please include it in your page.");const t={chatId:"",sessionEndpointUrl:"",backendStreamUrl:"",theme:{primaryColor:"#2563eb",secondaryColor:"#1e40af",userMessageBg:"#dbeafe",userMessageText:"#1e40af",botMessageBg:"#f3f4f6",botMessageText:"#1f2937",systemMessageBg:"#f3f4f6",systemMessageText:"#4b5563"},size:{width:"380px",height:"550px",buttonSize:"60px"},position:{bottom:"20px",right:"20px"},text:{headerTitle:"Chat Support",welcomeMessage:"Welcome! How can I help you today?",inputPlaceholder:"Type your message...",connectionError:"Connection error. Please try again later.",sendError:"Failed to send message. Please try again."},icons:{chatButton:'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',userAvatar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"></circle><path d="M12 11c-2.21 0-4 1.79-4 4v5h8v-5c0-2.21-1.79-4-4-4z"></path></svg>',botAvatar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"></circle><path d="M20 21v-2a7 7 0 0 0-14 0v2"></path></svg>',sendButton:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>'},predefinedQuestions:{enabled:!1,position:"top",style:"button",questions:[],buttonColor:"#3b82f6",textColor:"#ffffff",hoverColor:"#2563eb",hideAfterSelection:!1},sanitization:{input:"basic",output:!0}};e.StreamingChatWidget=class{constructor(e){e&&e.chatId?e.sessionEndpointUrl?e.backendStreamUrl?(this.config=this._mergeConfig(t,e),this.sessionToken=null,this.assistantId=null,this.isSessionInitialized=!1,this.streamState={currentBotMessage:null,activeMessageContent:"",isStreaming:!1,typingIndicator:null,sendingSpinner:null},this.elements={},this._setupDependencies(),this.namespace="sse-chat-"+Math.random().toString(36).substr(2,9),this._initUI()):console.error("StreamingChatWidget: backendStreamUrl is required."):console.error("StreamingChatWidget: sessionEndpointUrl is required."):console.error("StreamingChatWidget: chatId is required.")}_initUI(){this._createWidgetElements(),this._injectStyles(),this._attachEventListeners(),this.config.predefinedQuestions.enabled&&this._createPredefinedButtons()}async initSession(){if(!this.isSessionInitialized){if(!this.config.chatId||!this.config.sessionEndpointUrl)return console.error("StreamingChatWidget: Cannot init session. Missing chatId or sessionEndpointUrl in config."),void this._addMessage("system","Chat initialization failed: Configuration error.");try{this._addMessage("system","Initializing chat session...");const e=await fetch(this.config.sessionEndpointUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatid:this.config.chatId})});if(!e.ok){const t=await e.json().catch((()=>({detail:e.statusText})));throw new Error(t.detail||`HTTP error ${e.status}`)}const t=await e.json();this.sessionToken=t.session_token,this.assistantId=t.assistant_id,this.isSessionInitialized=!0,this._addMessage("system","Chat session started.")}catch(e){console.error("Error initiating chat session:",e),this._addMessage("system","Failed to start chat session: "+e.message),this.isSessionInitialized=!1}}}_handleStreamEvent(e,t){if("thread.message.delta"===e&&"text_delta"===t.type){if(!this.streamState.currentBotMessage&&this.elements.chatMessages){this._addMessage("bot","");const e=this.elements.chatMessages.querySelector(`.${this.namespace}-bot-message-container:last-child`);e&&(this.streamState.currentBotMessage=e.querySelector(`.${this.namespace}-bot-message`))}if(this.streamState.currentBotMessage&&t.content){this.streamState.activeMessageContent+=t.content;let e=marked.parse(this.streamState.activeMessageContent);const n=document.createElement("div");n.innerHTML=e;n.querySelectorAll("img").forEach((e=>{const t=e.getAttribute("title");if(t){const n=/style="([^"]*)"/,s=t.match(n);if(s&&s[1]){const i=s[1];e.style.cssText=e.style.cssText?e.style.cssText.replace(/;$/,"")+";"+i:i;let a=t.replace(n,"").replace(/\s*\/[\s)]*$/,"").trim();a?e.setAttribute("title",a):e.removeAttribute("title")}}})),e=n.innerHTML,this.streamState.currentBotMessage.innerHTML=DOMPurify.sanitize(e,{ADD_TAGS:["iframe","video","source"],ALLOW_TAGS:["b","i","em","strong","a","p","ul","ol","li","br","img","pre","code","blockquote","h1","h2","h3","h4","h5","h6","hr","span"],ALLOW_ATTR:["href","src","alt","title","target","rel","class","style","controls","autoplay","loop","muted","poster","preload","width","height","type","frameborder","allowfullscreen","allow"],ADD_ATTR:["target","rel"]});const s=document.createElement("div");s.innerHTML=this.streamState.currentBotMessage.innerHTML,s.querySelectorAll("a").forEach((e=>{try{const t=new URL(e.href);let n=null;if("www.youtube.com"===t.hostname||"youtube.com"===t.hostname?"/watch"===t.pathname?n=t.searchParams.get("v"):t.pathname.startsWith("/embed/")&&(n=t.pathname.substring(7)):"youtu.be"===t.hostname&&(n=t.pathname.substring(1)),n){const t=document.createElement("iframe");t.setAttribute("src",`https://www.youtube.com/embed/${n}`),t.setAttribute("width","100%");const i=this.streamState.currentBotMessage.offsetWidth||300;t.setAttribute("height",`${Math.round(9*i/16)}`),t.setAttribute("frameborder","0"),t.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"),t.setAttribute("allowfullscreen",""),e.parentNode&&e.parentNode!==s?e.parentNode.replaceChild(t,e):e.parentNode===s&&s.replaceChild(t,e)}}catch(t){console.warn("Could not process link for YouTube embed (incremental):",e.href,t)}})),this.streamState.currentBotMessage.innerHTML=s.innerHTML,this._scrollToBottom()}}else"thread.run.completed"===e?(this.streamState.isStreaming=!1,this._removeTypingIndicator(),this.streamState.currentBotMessage=null,this.streamState.activeMessageContent=""):"thread.run.failed"===e||"error"===e?(this._addMessage("system",`Error: ${t.error||t.detail||"An unknown error occurred."}`),this.streamState.isStreaming=!1,this._removeTypingIndicator(),this.streamState.currentBotMessage=null,this.streamState.activeMessageContent=""):"stream_end"===e&&(this.streamState.isStreaming=!1,this._removeTypingIndicator(),this.streamState.currentBotMessage&&this.streamState.activeMessageContent,this.streamState.currentBotMessage=null,this.streamState.activeMessageContent="")}async _streamResponseFromServer(e){if(!this.isSessionInitialized||!this.sessionToken)return this._addMessage("system","Session not initialized. Please try again."),void this._removeSendingSpinner();if(!this.config.backendStreamUrl)return console.error("StreamingChatWidget: backendStreamUrl is not configured."),this._addMessage("system","Chat stream endpoint not configured."),void this._removeSendingSpinner();this.streamState.isStreaming=!0,this.streamState.activeMessageContent="",this.streamState.currentBotMessage=null;try{const t=await fetch(this.config.backendStreamUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_token:this.sessionToken,message:e})});if(this._removeSendingSpinner(),!t.ok||!t.body){const e=await t.json().catch((()=>({detail:t.statusText})));return this._addMessage("system",`Error: ${e.detail||"Failed to connect to stream"}`),void(this.streamState.isStreaming=!1)}this._showTypingIndicator();const n=t.body.getReader(),s=new TextDecoder;let i="";for(;;){const{value:e,done:t}=await n.read();if(t){i.trim().length>0&&console.warn("Stream ended with unprocessed buffer:",i),this.streamState.isStreaming&&this._handleStreamEvent("stream_end",{message:"Stream closed by server."});break}i+=s.decode(e,{stream:!0});let a=i.indexOf("\n\n");for(;-1!==a;){const e=i.substring(0,a);i=i.substring(a+2);let t="message",n=[];e.split("\n").forEach((e=>{e.startsWith("event:")?t=e.substring(6).trim():e.startsWith("data:")&&n.push(e.substring(5).trim())}));const s=n.join("");if(s)try{const e=JSON.parse(s);if("cached_message"===t)if(console.log("[DEBUG cached_message_handler] Received event. Parsed data:",e),e.role&&e.content){const t="assistant"===e.role?"bot":e.role;console.log(`[DEBUG cached_message_handler] Attempting to call _addMessage with type: "${t}" (original role: "${e.role}"), content snippet: "${e.content?e.content.substring(0,30)+"...":"EMPTY"}"`);try{this._addMessage(t,e.content),console.log(`[DEBUG cached_message_handler] Completed call to _addMessage for type: "${t}" (original role: "${e.role}")`)}catch(n){console.error(`[DEBUG cached_message_handler] Error during _addMessage call for type "${t}" (original role "${e.role}"):`,n)}}else console.warn("[DEBUG cached_message_handler] Parsed data missing role or content:",e);else this._handleStreamEvent(t,e)}catch(e){console.error("Error parsing SSE data:",s,e)}a=i.indexOf("\n\n")}}}catch(e){console.error("Streaming fetch error:",e),this._addMessage("system","Connection error during streaming."),this.streamState.isStreaming=!1,this._removeTypingIndicator(),this._removeSendingSpinner()}}_setupDependencies(){marked.setOptions({gfm:!0,breaks:!0,sanitize:!1,highlight:function(e,t){return e},renderer:new marked.Renderer})}_darkenColor(e,t){e=e.replace(/^#/,"");let n=parseInt(e.substring(0,2),16),s=parseInt(e.substring(2,4),16),i=parseInt(e.substring(4,6),16);return n=Math.floor(n*(100-t)/100),s=Math.floor(s*(100-t)/100),i=Math.floor(i*(100-t)/100),`#${n.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`}_mergeConfig(e,t){const n=JSON.parse(JSON.stringify(e));for(const e in t)t.hasOwnProperty(e)&&("object"!=typeof t[e]||null===t[e]||"object"!=typeof n[e]||null===n[e]||Array.isArray(t[e])?n[e]=t[e]:n[e]=this._mergeConfig(n[e],t[e]));return n}_isUrl(e){try{return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||/^(www\.)[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/i.test(e)}catch(e){return!1}}_parseIconConfig(e){try{const t=JSON.parse(e);return t&&"object"==typeof t&&t.url?t:null}catch(e){return null}}_createIconElement(e,t=null){if(!e)return"";const n=this._parseIconConfig(e);if(n){const e=n.size||t||"24",s=n.size||t||"24";let i="max-width: 100%; height: auto;";return`<img src="${n.url}" width="${e}" height="${s}" alt="Icon" style="${i}">`}if(this._isUrl(e)){return`<img src="${e}" width="${t||"24"}" height="${t||"24"}" alt="Icon" style="max-width: 100%; height: auto;">`}return e}_createWidgetElements(){const e=document.createElement("button");e.id=`${this.namespace}-button`,e.className=`${this.namespace}-button`,e.innerHTML=this._createIconElement(this.config.icons.chatButton),document.body.appendChild(e),this.elements.chatButton=e;const t=document.createElement("div");t.id=`${this.namespace}-panel`,t.className=`${this.namespace}-panel`,document.body.appendChild(t),this.elements.chatPanel=t;const n=document.createElement("div");n.className=`${this.namespace}-header`;const s=document.createElement("div");s.textContent=this.config.text.headerTitle;const i=document.createElement("div");i.className=`${this.namespace}-close`,i.innerHTML="&times;",n.appendChild(s),n.appendChild(i),t.appendChild(n),this.elements.chatHeader=n,this.elements.closeButton=i;const a=document.createElement("div");if(a.className=`${this.namespace}-messages`,t.appendChild(a),this.elements.chatMessages=a,this.config.text.welcomeMessage){const e=document.createElement("div");e.className=`${this.namespace}-message-with-avatar ${this.namespace}-bot-message-container`;const t=document.createElement("div");t.className=`${this.namespace}-avatar ${this.namespace}-bot-avatar`,t.innerHTML=this._createIconElement(this.config.icons.botAvatar);const n=document.createElement("div");n.className=`${this.namespace}-message ${this.namespace}-bot-message`,n.textContent=this.config.text.welcomeMessage,e.appendChild(t),e.appendChild(n),a.appendChild(e)}const r=document.createElement("div");r.className=`${this.namespace}-input-container`;const o=document.createElement("input");o.type="text",o.className=`${this.namespace}-input`,o.placeholder=this.config.text.inputPlaceholder;const d=document.createElement("button");d.className=`${this.namespace}-send-button`,d.innerHTML=this._createIconElement(this.config.icons.sendButton),r.appendChild(o),r.appendChild(d),t.appendChild(r);const c=document.createElement("div");c.className=`${this.namespace}-powered-by`,c.innerHTML='powered by <a href="https://www.fxrsoft.com" target="_blank">fxrsoft</a>',t.appendChild(c),this.elements.inputContainer=r,this.elements.chatInput=o,this.elements.sendButton=d,this.elements.poweredBy=c}_createPredefinedButtons(){if(!this.config.predefinedQuestions.enabled||!this.config.predefinedQuestions.questions||0===this.config.predefinedQuestions.questions.length)return;const e=document.createElement("div");if(e.className=`${this.namespace}-predefined-container`,e.classList.add(`${this.namespace}-predefined-${this.config.predefinedQuestions.position}`),this.config.predefinedQuestions.questions.forEach((t=>{const n=document.createElement("button");n.className=`${this.namespace}-predefined-button`,n.classList.add(`${this.namespace}-predefined-${this.config.predefinedQuestions.style}`);const s=t.text&&"object"==typeof t.text?"":String(t.text||"");n.textContent=s,n.addEventListener("click",(()=>{let e=t.value||t.text;"object"==typeof e&&(e=s),this._handlePredefinedQuestion(e)})),e.appendChild(n)})),"top"===this.config.predefinedQuestions.position)this.elements.chatMessages.insertBefore(e,this.elements.chatMessages.firstChild);else if("bottom"===this.config.predefinedQuestions.position)this.elements.chatPanel.insertBefore(e,this.elements.inputContainer);else if("welcome"===this.config.predefinedQuestions.position){e.classList.remove(`${this.namespace}-predefined-welcome`),e.classList.add(`${this.namespace}-predefined-top`),this.elements.chatMessages.insertBefore(e,this.elements.chatMessages.firstChild);const t=this.elements.chatMessages.querySelector(`.${this.namespace}-bot-message-container`);t&&(e.classList.remove(`${this.namespace}-predefined-top`),e.classList.add(`${this.namespace}-predefined-welcome`),this.elements.chatMessages.insertBefore(e,t.nextSibling))}this.elements.predefinedContainer=e}async _handlePredefinedQuestion(e){const t="object"==typeof e?e.toString&&"[object Object]"!==e.toString()?e.toString():"":String(e||"");await this.sendMessage(t),this.config.predefinedQuestions.hideAfterSelection&&this.elements.predefinedContainer&&(this.elements.predefinedContainer.style.display="none")}_injectStyles(){const{theme:e,size:t,position:n}=this.config,s=this.namespace;let i=`background-color: ${e.primaryColor};`;if(this.config.iconStyles&&this.config.iconStyles.chatButton){const e=this.config.iconStyles.chatButton;e.transparent?i="background-color: transparent !important;":e.backgroundColor&&(i=`background-color: ${e.backgroundColor};`)}const a=`\n        /* Chat Widget Styles */\n        .${s}-button {\n          position: fixed;\n          bottom: ${n.bottom};\n          right: ${n.right};\n          width: ${t.buttonSize};\n          height: ${t.buttonSize};\n          border-radius: 50%;\n          ${i}\n          color: white;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          cursor: pointer;\n          border: none;\n          box-shadow: 0 2px 10px rgba(0,0,0,0.2);\n          z-index: 9999;\n          transition: transform 0.2s;\n        }\n        \n        .${s}-button:hover {\n          transform: scale(1.05);\n        }\n        \n        .${s}-panel {\n          position: fixed;\n          bottom: calc(${n.bottom} + 80px);\n          right: ${n.right};\n          width: ${t.width};\n          height: ${t.height};\n          background: white;\n          border-radius: 10px;\n          box-shadow: 0 5px 15px rgba(0,0,0,0.2);\n          display: none;\n          flex-direction: column;\n          overflow: hidden;\n          z-index: 9998;\n        }\n        \n        .${s}-header {\n          background: ${e.primaryColor};\n          color: white;\n          padding: 15px;\n          display: flex;\n          justify-content: space-between;\n          align-items: center;\n          font-weight: bold;\n        }\n        \n        .${s}-close {\n          cursor: pointer;\n          font-size: 20px;\n        }\n        \n        .${s}-messages {\n          flex: 1;\n          padding: 15px;\n          overflow-y: auto;\n          display: flex;\n          flex-direction: column;\n        }\n        \n        .${s}-avatar {\n          width: 32px;\n          height: 32px;\n          border-radius: 50%;\n          color: white;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n          flex-shrink: 0;\n        }\n        \n        .${s}-bot-avatar {\n          background-color: ${e.primaryColor};\n          margin-right: 10px;\n        }\n        \n        .${s}-user-avatar {\n          background-color: ${e.secondaryColor};\n          margin-left: 10px;\n        }\n        \n        .${s}-message-with-avatar {\n          display: flex;\n          align-items: flex-start;\n          max-width: 85%;\n          margin-bottom: 10px;\n          gap: 16px;\n        }\n        \n        .${s}-bot-message-container {\n          align-self: flex-start;\n        }\n        \n        .${s}-user-message-container {\n          align-self: flex-end;\n          flex-direction: row-reverse;\n          gap: 20px;\n        }\n        \n        .${s}-message {\n          max-width: 100%;\n          margin-bottom: 0;\n          padding: 10px 15px;\n          border-radius: 18px;\n          overflow-wrap: break-word;\n          overflow: hidden;\n        }\n        \n        .${s}-message p {\n          margin: 0 0 10px 0;\n        }\n        \n        .${s}-message p:last-child {\n          margin-bottom: 0;\n        }\n        \n        .${s}-system-message {\n          align-self: center;\n          background-color: ${e.systemMessageBg};\n          color: ${e.systemMessageText};\n          text-align: center;\n          border-radius: 8px;\n          padding: 8px 12px;\n          margin: 10px 0;\n          font-size: 0.875rem;\n          max-width: 85%;\n        }\n        \n        .${s}-connected-status {\n          color: #10b981; /* Green color for connected status */\n          font-weight: 500;\n          animation: fadeIn 0.3s ease-in;\n        }\n        \n        @keyframes fadeIn {\n          0% { opacity: 0; }\n          100% { opacity: 1; }\n        }\n        \n        .${s}-user-message {\n          align-self: flex-end;\n          background-color: ${e.userMessageBg};\n          color: ${e.userMessageText};\n          border-radius: 18px 18px 0 18px;\n        }\n        \n        .${s}-bot-message {\n          align-self: flex-start;\n          background-color: ${e.botMessageBg};\n          color: ${e.botMessageText};\n          border-radius: 18px 18px 18px 0;\n        }\n        \n        .${s}-input-container {\n          display: flex;\n          padding: 10px;\n          border-top: 1px solid #e5e7eb;\n        }\n        \n        .${s}-input {\n          flex: 1;\n          padding: 10px 15px;\n          border-radius: 24px;\n          border: 1px solid #d1d5db;\n          margin-right: 10px;\n          outline: none;\n          font-size: 16px;\n        }\n        \n        .${s}-input:focus {\n          border-color: ${e.primaryColor};\n        }\n        \n        .${s}-send-button {\n          background: ${e.primaryColor};\n          color: white;\n          border: none;\n          border-radius: 50%;\n          width: 40px;\n          height: 40px;\n          cursor: pointer;\n          display: flex;\n          align-items: center;\n          justify-content: center;\n        }\n        \n        .${s}-send-button:hover {\n          background: ${this._darkenColor(e.primaryColor,10)};\n        }\n        \n        /* Typing indicator */\n        .${s}-typing-indicator {\n          display: flex;\n          align-items: center;\n          margin-bottom: 10px;\n          align-self: flex-start;\n        }\n        \n        .${s}-typing-indicator span {\n          height: 8px;\n          width: 8px;\n          background-color: #6b7280;\n          border-radius: 50%;\n          display: inline-block;\n          margin-right: 2px;\n          animation: ${s}-typing 1.4s infinite both;\n        }\n        \n        .${s}-typing-indicator span:nth-child(2) {\n          animation-delay: 0.2s;\n        }\n        \n        .${s}-typing-indicator span:nth-child(3) {\n          animation-delay: 0.4s;\n        }\n        \n        @keyframes ${s}-typing {\n          0% { transform: translateY(0px); }\n          30% { transform: translateY(-5px); }\n          60%, 100% { transform: translateY(0px); }\n        }\n        \n        /* Sending spinner */\n        .${s}-sending-spinner {\n          display: flex;\n          align-items: center;\n          align-self: flex-end;\n          margin: 8px 20px 8px 0;\n          opacity: 0;\n          transition: opacity 0.3s ease;\n        }\n        \n        .${s}-sending-spinner.${s}-active {\n          opacity: 1;\n        }\n        \n        .${s}-sending-spinner-dots {\n          display: flex;\n        }\n        \n        .${s}-sending-spinner-dots span {\n          height: 8px;\n          width: 8px;\n          background-color: ${e.primaryColor};\n          border-radius: 50%;\n          margin-right: 4px;\n          animation: ${s}-sending-pulse 1.5s infinite ease-in-out both;\n        }\n        \n        .${s}-sending-spinner-dots span:nth-child(2) {\n          animation-delay: 0.2s;\n        }\n        \n        .${s}-sending-spinner-dots span:nth-child(3) {\n          animation-delay: 0.4s;\n          margin-right: 0;\n        }\n        \n        @keyframes ${s}-sending-pulse {\n          0%, 80%, 100% { transform: scale(0.8); opacity: 0.6; }\n          40% { transform: scale(1.2); opacity: 1; }\n        }\n        \n        /* Predefined questions */\n        .${s}-predefined-container {\n          display: flex;\n          flex-wrap: wrap;\n          gap: 8px;\n          padding: 10px 15px;\n        }\n        \n        .${s}-predefined-top {\n          border-bottom: 1px solid rgba(0,0,0,0.1);\n        }\n        \n        .${s}-predefined-bottom {\n          border-top: 1px solid rgba(0,0,0,0.1);\n        }\n        \n        .${s}-predefined-welcome {\n          margin-top: 5px;\n          margin-bottom: 10px;\n          background-color: rgba(0,0,0,0.02);\n          border-radius: 10px;\n        }\n        \n        .${s}-predefined-button {\n          border: none;\n          padding: 8px 16px;\n          font-size: ${this.config.predefinedQuestions.fontSize||"14px"};\n          cursor: pointer;\n          transition: background-color 0.2s;\n          ${this.config.predefinedQuestions.allowTextWrapping?"white-space: nowrap; ":"white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 200px;"}\n          background-color: ${this.config.predefinedQuestions.buttonColor};\n          color: ${this.config.predefinedQuestions.textColor};\n        }\n        \n        .${s}-predefined-button:hover {\n          background-color: ${this.config.predefinedQuestions.hoverColor};\n        }\n        \n        .${s}-predefined-button {\n          border-radius: 16px;\n        }\n        \n        .${s}-predefined-pill {\n          border-radius: 24px;\n        }\n        \n        /* Powered by section */\n        .${s}-powered-by {\n          text-align: center;\n          font-size: 12px;\n          color: #9ca3af;\n          padding: 5px 0;\n          border-top: 1px solid #e5e7eb;\n        }\n        \n        .${s}-powered-by a {\n          color: ${e.primaryColor};\n          text-decoration: none;\n        }\n        \n        .${s}-powered-by a:hover {\n          text-decoration: underline;\n        }\n        \n        /* Markdown formatting for messages */\n        .${s}-message a {\n          color: ${e.primaryColor};\n          text-decoration: none;\n        }\n        .${s}-message a:hover {\n          text-decoration: underline;\n        }\n        .${s}-message code {\n          font-family: monospace;\n          background-color: rgba(0,0,0,0.05);\n          padding: 2px 4px;\n          border-radius: 4px;\n        }\n        .${s}-message pre {\n          background-color: rgba(0,0,0,0.05);\n          padding: 10px;\n          border-radius: 4px;\n          overflow-x: auto;\n        }\n        \n        /* Image formatting for messages */\n        .${s}-message img {\n          max-width: 100%;\n          height: auto;\n          border-radius: 4px;\n          margin: 4px 0;\n          display: block;\n        }\n        \n        /* Responsive styles for small screens (less than 800px width) */\n        @media (max-width: 800px) {\n          .${s}-panel {\n            width: calc(100% - 20px);\n            max-width: 100%;\n            right: 10px;\n            left: 10px;\n            height: 70vh;\n            max-height: 550px;\n            bottom: 70px;\n          }\n          \n          .${s}-button {\n            width: 50px;\n            height: 50px;\n            bottom: 10px;\n            right: 10px;\n          }\n          \n          .${s}-messages {\n            max-height: calc(70vh - 120px);\n          }\n          \n          .${s}-input-container {\n            padding: 8px;\n          }\n          \n          .${s}-input {\n            padding: 8px 12px;\n            font-size: 14px;\n          }\n          \n          .${s}-message-with-avatar {\n            max-width: 95%;\n          }\n          \n          .${s}-predefined-container {\n            padding: 8px;\n            gap: 5px;\n          }\n          \n          .${s}-predefined-button {\n            padding: 6px 12px;\n            font-size: 13px;\n          }\n        }\n      `,r=document.createElement("style");r.textContent=a,document.head.appendChild(r)}_attachEventListeners(){this.elements.chatButton.addEventListener("click",(()=>{this.toggleChat()})),this.elements.closeButton.addEventListener("click",(()=>{this.hideChat()})),this.elements.sendButton.addEventListener("click",(()=>{this.sendMessage()})),this.elements.chatInput.addEventListener("keypress",(e=>{"Enter"===e.key&&this.sendMessage()}))}destroy(){this.elements&&"object"==typeof this.elements&&(Object.values(this.elements).forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})),this.elements={});document.querySelectorAll("style").forEach((e=>{e.textContent&&e.textContent.includes(this.namespace)&&e.parentNode&&e.parentNode.removeChild(e)})),this.streamState={currentBotMessage:null,activeMessageContent:"",isStreaming:!1,typingIndicator:null,sendingSpinner:null}}_updateMessage(e,t){if("bot"!==e||!this.streamState.currentBotMessage)return;const n=this.streamState.currentBotMessage.querySelector(`.${this.namespace}-bot-message`);if(n){if(this.config.sanitization.output){const e=marked.parse(t),s=DOMPurify.sanitize(e,{ALLOW_TAGS:["b","i","em","strong","a","p","ul","ol","li","br","img","pre","code","blockquote","h1","h2","h3","h4","h5","h6","hr","span"],ALLOW_ATTR:["href","src","alt","title","target","rel","class","style"],ADD_ATTR:["target","rel"]});n.innerHTML=s}else n.innerHTML=marked.parse(t);this._scrollToBottom()}}_showSendingSpinner(){this._removeSendingSpinner();const e=document.createElement("div");e.className=`${this.namespace}-sending-spinner`;const t=document.createElement("div");t.className=`${this.namespace}-sending-spinner-dots`;for(let e=0;e<3;e++){const e=document.createElement("span");t.appendChild(e)}e.appendChild(t),this.elements.chatMessages.appendChild(e),this.streamState.sendingSpinner=e,setTimeout((()=>{e&&e.parentNode&&e.classList.add(`${this.namespace}-active`)}),10)}_removeSendingSpinner(){this.streamState.sendingSpinner&&this.streamState.sendingSpinner.parentNode&&(this.streamState.sendingSpinner.parentNode.removeChild(this.streamState.sendingSpinner),this.streamState.sendingSpinner=null)}_showTypingIndicator(){if(this.streamState.typingIndicator&&this.streamState.typingIndicator.parentNode)return;const e=document.createElement("div");e.className=`${this.namespace}-typing-indicator`;for(let t=0;t<3;t++){const t=document.createElement("span");e.appendChild(t)}this.elements.chatMessages.appendChild(e),this.streamState.typingIndicator=e,this._scrollToBottom()}_removeTypingIndicator(){this.streamState.typingIndicator&&this.streamState.typingIndicator.parentNode&&(this.streamState.typingIndicator.parentNode.removeChild(this.streamState.typingIndicator),this.streamState.typingIndicator=null)}_addMessage(e,t){if(this.elements.chatMessages){if("system"===e){const e=document.createElement("div");e.className=`${this.namespace}-system-message`,e.textContent=t,this.elements.chatMessages.appendChild(e),"Initializing chat session..."!==t&&"Chat session started."!==t&&"Initializing session before sending..."!==t||setTimeout((()=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),3e3)}else if("user"===e){const e=document.createElement("div");e.className=`${this.namespace}-message-with-avatar ${this.namespace}-user-message-container`;const n=document.createElement("div");n.className=`${this.namespace}-avatar ${this.namespace}-user-avatar`,n.innerHTML=this._createIconElement(this.config.icons.userAvatar);const s=document.createElement("div");s.className=`${this.namespace}-message ${this.namespace}-user-message`,s.textContent=t,e.appendChild(n),e.appendChild(s),this.elements.chatMessages.appendChild(e)}else if("bot"===e){const e=document.createElement("div");e.className=`${this.namespace}-message-with-avatar ${this.namespace}-bot-message-container`,console.log(`[DEBUG _addMessage type='bot'] Entered. Content: "${t?t.substring(0,50)+"...":"EMPTY"}"`);const n=document.createElement("div");n.className=`${this.namespace}-avatar ${this.namespace}-bot-avatar`,n.innerHTML=this._createIconElement(this.config.icons.botAvatar),console.log("[DEBUG _addMessage type='bot'] Created avatar element:",n);const s=document.createElement("div");s.className=`${this.namespace}-message ${this.namespace}-bot-message`,console.log("[DEBUG _addMessage type='bot'] Created message element:",s);const i=marked.parse(t||"");if(console.log("[DEBUG _addMessage type='bot'] Raw HTML from marked.parse:",i?i.substring(0,100)+"...":"EMPTY"),this.config.sanitization.output?(s.innerHTML=DOMPurify.sanitize(i,{ADD_TAGS:["iframe","video","source"],ALLOW_TAGS:["b","i","em","strong","a","p","ul","ol","li","br","img","pre","code","blockquote","h1","h2","h3","h4","h5","h6","hr","span"],ALLOW_ATTR:["href","src","alt","title","target","rel","class","style","controls","autoplay","loop","muted","poster","preload","width","height","type","frameborder","allowfullscreen","allow"],ADD_ATTR:["target","rel"]}),console.log("[DEBUG _addMessage type='bot'] Sanitized HTML:",s.innerHTML?s.innerHTML.substring(0,100)+"...":"EMPTY")):(s.innerHTML=i,console.log("[DEBUG _addMessage type='bot'] HTML (no sanitization):",s.innerHTML?s.innerHTML.substring(0,100)+"...":"EMPTY")),e.appendChild(n),e.appendChild(s),console.log("[DEBUG _addMessage type='bot'] Created wrapper. Wrapper outerHTML:",e.outerHTML?e.outerHTML.substring(0,200)+"...":"EMPTY"),this.elements.chatMessages){console.log("[DEBUG _addMessage type='bot'] this.elements.chatMessages exists. Current innerHTML (first 200 chars):",this.elements.chatMessages.innerHTML?this.elements.chatMessages.innerHTML.substring(0,200)+"...":"EMPTY"),console.log("[DEBUG _addMessage type='bot'] Attempting to append wrapper to chatMessages. Wrapper valid:",e instanceof Node);try{this.elements.chatMessages.appendChild(e),console.log("[DEBUG _addMessage type='bot'] Successfully appended wrapper to chatMessages. chatMessages new innerHTML (first 200 chars):",this.elements.chatMessages.innerHTML?this.elements.chatMessages.innerHTML.substring(0,200)+"...":"EMPTY")}catch(e){console.error("[DEBUG _addMessage type='bot'] ERROR during appendChild:",e)}}else console.error("[DEBUG _addMessage type='bot'] ERROR: this.elements.chatMessages is null or undefined! Cannot append message.")}this._scrollToBottom()}}_scrollToBottom(){this.elements.chatMessages&&(this.elements.chatMessages.scrollTop=this.elements.chatMessages.scrollHeight)}async sendMessage(e){let t=e;if(!t){if(t=this.elements.chatInput.value.trim(),!t)return;this.elements.chatInput.value=""}if(this._addMessage("user",t),!this.isSessionInitialized&&(this._addMessage("system","Initializing session before sending..."),await this.initSession(),!this.isSessionInitialized))return this._addMessage("system","Session initialization failed. Cannot send message."),void this._removeSendingSpinner();this._showSendingSpinner(),this._streamResponseFromServer(t)}toggleChat(){"flex"===this.elements.chatPanel.style.display?this.hideChat():this.showChat()}showChat(){this.elements.chatPanel.style.display="flex",setTimeout((()=>{this.elements.chatInput&&this.elements.chatInput.focus()}),100),this._scrollToBottom()}hideChat(){this.elements.chatPanel.style.display="none"}on(e,t){console.log(`Event '${e}' registered but handling not implemented yet`)}}}(window);