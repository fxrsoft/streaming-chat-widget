!function(e,n){"object"==typeof exports&&"undefined"!=typeof module?module.exports=n():"function"==typeof define&&define.amd?define(n):(e="undefined"!=typeof globalThis?globalThis:e||self).StreamingChatWidget=n()}(this,(function(){"use strict";const e={chatId:"",sessionEndpointUrl:"",backendStreamUrl:"",theme:{primaryColor:"#2563eb",secondaryColor:"#1e40af",userMessageBg:"#dbeafe",userMessageText:"#1e40af",botMessageBg:"#f3f4f6",botMessageText:"#1f2937",systemMessageBg:"#f3f4f6",systemMessageText:"#4b5563"},size:{width:"380px",height:"550px",buttonSize:"60px"},position:{bottom:"20px",right:"20px"},text:{headerTitle:"Chat Support",welcomeMessage:"Welcome! How can I help you today?",inputPlaceholder:"Type your message...",connectionError:"Connection error. Please try again later.",sendError:"Failed to send message. Please try again."},icons:{chatButton:'<svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z"></path></svg>',userAvatar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="7" r="4"></circle><path d="M12 11c-2.21 0-4 1.79-4 4v5h8v-5c0-2.21-1.79-4-4-4z"></path></svg>',botAvatar:'<svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="8" r="5"></circle><path d="M20 21v-2a7 7 0 0 0-14 0v2"></path></svg>',sendButton:'<svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="22" y1="2" x2="11" y2="13"></line><polygon points="22 2 15 22 11 13 2 9 22 2"></polygon></svg>'},predefinedQuestions:{enabled:!1,position:"top",style:"button",questions:[],buttonColor:"#3b82f6",textColor:"#ffffff",hoverColor:"#2563eb",hideAfterSelection:!1},sanitization:{input:"basic",output:!0}};function n(e,t){const s=JSON.parse(JSON.stringify(e));for(const i in t)t.hasOwnProperty(i)&&("object"!=typeof t[i]||null===t[i]||"object"!=typeof s[i]||null===s[i]||Array.isArray(t[i])?s[i]=t[i]:s[i]=n(s[i],t[i]));return s}function t(e,n=null){if(!e)return"";const t=function(e){if("string"!=typeof e)return null;try{const n=JSON.parse(e);return n&&"object"==typeof n&&n.url?n:null}catch(n){return null}}(e);if(t){const e=t.size||n||"24",s=t.size||n||"24",i=String(e),a=String(s);let o="max-width: 100%; height: auto;";return`<img src="${t.url}" width="${i.replace("px","")}" height="${a.replace("px","")}" alt="Icon" style="${o}">`}if(function(e){if("string"!=typeof e)return!1;try{return e.startsWith("http://")||e.startsWith("https://")||e.startsWith("data:")||/^(www\.)[-a-zA-Z0-9@:%._\+~#=]{2,256}\.[a-z]{2,6}\b([-a-zA-Z0-9@:%_\+.~#?&//=]*)$/i.test(e)}catch(n){return!1}}(e)){const t=n||"24",s=String(n||"24"),i=String(t);return`<img src="${e}" width="${s.replace("px","")}" height="${i.replace("px","")}" alt="Icon" style="max-width: 100%; height: auto;">`}return e}function s(e){const{config:n,namespace:t}=e,{theme:s,size:i,position:a}=n;let o=`background-color: ${s.primaryColor};`,r="box-shadow: 0 2px 10px rgba(0,0,0,0.2);";if(n.iconStyles&&n.iconStyles.chatButton){const e=n.iconStyles.chatButton;e.transparent?(o="background-color: transparent !important;",r="box-shadow: none !important;"):e.backgroundColor&&(o=`background-color: ${e.backgroundColor};`)}const d=`\n    /* Chat Widget Styles */\n    .${t}-button {\n      position: fixed;\n      bottom: ${a.bottom};\n      right: ${a.right};\n      width: ${i.buttonSize};\n      height: ${i.buttonSize};\n      border-radius: 50%;\n      ${o}\n      ${r}\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      cursor: pointer;\n      border: none;\n      z-index: 9999;\n      transition: transform 0.2s;\n    }\n    \n    .${t}-button:hover {\n      transform: scale(1.05);\n    }\n    \n    .${t}-panel {\n      position: fixed;\n      bottom: calc(${a.bottom} + 80px);\n      right: ${a.right};\n      width: ${i.width};\n      height: ${i.height};\n      background: white;\n      border-radius: 10px;\n      box-shadow: 0 5px 15px rgba(0,0,0,0.2);\n      display: none;\n      flex-direction: column;\n      overflow: hidden;\n      z-index: 9998;\n    }\n    \n    .${t}-header {\n      background: ${s.primaryColor};\n      color: white;\n      padding: 15px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      font-weight: bold;\n    }\n    \n    .${t}-close {\n      cursor: pointer;\n      font-size: 20px;\n    }\n    \n    .${t}-messages {\n      flex: 1;\n      padding: 15px;\n      overflow-y: auto;\n      display: flex;\n      flex-direction: column;\n    }\n    \n    .${t}-avatar {\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      color: white;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      flex-shrink: 0;\n    }\n    \n    .${t}-bot-avatar {\n      background-color: ${s.primaryColor};\n      margin-right: 10px;\n    }\n    \n    .${t}-user-avatar {\n      background-color: ${s.secondaryColor};\n      margin-left: 10px;\n    }\n    \n    .${t}-message-with-avatar {\n      display: flex;\n      align-items: flex-start;\n      max-width: 85%;\n      margin-bottom: 10px;\n      gap: 16px;\n    }\n    \n    .${t}-bot-message-container {\n      align-self: flex-start;\n    }\n    \n    .${t}-user-message-container {\n      align-self: flex-end;\n      flex-direction: row-reverse;\n      gap: 20px;\n    }\n    \n    .${t}-message {\n      max-width: 100%;\n      margin-bottom: 0;\n      padding: 10px 15px;\n      border-radius: 18px;\n      overflow-wrap: break-word;\n      overflow: hidden;\n    }\n    \n    .${t}-message p {\n      margin: 0 0 10px 0;\n    }\n    \n    .${t}-message p:last-child {\n      margin-bottom: 0;\n    }\n    \n    .${t}-system-message {\n      align-self: center;\n      background-color: ${s.systemMessageBg};\n      color: ${s.systemMessageText};\n      text-align: center;\n      border-radius: 8px;\n      padding: 8px 12px;\n      margin: 10px 0;\n      font-size: 0.875rem;\n      max-width: 85%;\n    }\n    \n    .${t}-connected-status {\n      color: #10b981; /* Green color for connected status */\n      font-weight: 500;\n      animation: fadeIn 0.3s ease-in;\n    }\n    \n    @keyframes fadeIn {\n      0% { opacity: 0; }\n      100% { opacity: 1; }\n    }\n    \n    .${t}-user-message {\n      align-self: flex-end;\n      background-color: ${s.userMessageBg};\n      color: ${s.userMessageText};\n      border-radius: 18px 18px 0 18px;\n    }\n    \n    .${t}-bot-message {\n      align-self: flex-start;\n      background-color: ${s.botMessageBg};\n      color: ${s.botMessageText};\n      border-radius: 18px 18px 18px 0;\n    }\n    \n    .${t}-input-container {\n      display: flex;\n      padding: 10px;\n      border-top: 1px solid #e5e7eb;\n    }\n    \n    .${t}-input {\n      flex: 1;\n      padding: 10px 15px;\n      border-radius: 24px;\n      border: 1px solid #d1d5db;\n      margin-right: 10px;\n      outline: none;\n      font-size: 16px;\n    }\n    \n    .${t}-input:focus {\n      border-color: ${s.primaryColor};\n    }\n    \n    .${t}-send-button {\n      background: ${s.primaryColor};\n      color: white;\n      border: none;\n      border-radius: 50%;\n      width: 40px;\n      height: 40px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    \n    .${t}-send-button:hover {\n      background: ${function(e,n){e=e.replace(/^#/,"");let t=parseInt(e.substring(0,2),16),s=parseInt(e.substring(2,4),16),i=parseInt(e.substring(4,6),16);return t=Math.floor(t*(100-n)/100),s=Math.floor(s*(100-n)/100),i=Math.floor(i*(100-n)/100),`#${t.toString(16).padStart(2,"0")}${s.toString(16).padStart(2,"0")}${i.toString(16).padStart(2,"0")}`}(s.primaryColor,10)}; /* from utils.js */\n    }\n    \n    /* Typing indicator */\n    .${t}-typing-indicator {\n      display: flex;\n      align-items: center;\n      margin-bottom: 10px;\n      align-self: flex-start;\n    }\n    \n    .${t}-typing-indicator span {\n      height: 8px;\n      width: 8px;\n      background-color: #6b7280;\n      border-radius: 50%;\n      display: inline-block;\n      margin-right: 2px;\n      animation: ${t}-typing 1.4s infinite both;\n    }\n    \n    .${t}-typing-indicator span:nth-child(2) {\n      animation-delay: 0.2s;\n    }\n    \n    .${t}-typing-indicator span:nth-child(3) {\n      animation-delay: 0.4s;\n    }\n    \n    @keyframes ${t}-typing {\n      0% { transform: translateY(0px); }\n      30% { transform: translateY(-5px); }\n      60%, 100% { transform: translateY(0px); }\n    }\n    \n    /* Sending spinner */\n    .${t}-sending-spinner {\n      display: flex;\n      align-items: center;\n      align-self: flex-end;\n      margin: 8px 20px 8px 0;\n      opacity: 0;\n      transition: opacity 0.3s ease;\n    }\n    \n    .${t}-sending-spinner.${t}-active {\n      opacity: 1;\n    }\n    \n    .${t}-sending-spinner-dots {\n      display: flex;\n    }\n    \n    .${t}-sending-spinner-dots span {\n      height: 8px;\n      width: 8px;\n      background-color: ${s.primaryColor};\n      border-radius: 50%;\n      margin-right: 4px;\n      animation: ${t}-sending-pulse 1.5s infinite ease-in-out both;\n    }\n    \n    .${t}-sending-spinner-dots span:nth-child(2) {\n      animation-delay: 0.2s;\n    }\n    \n    .${t}-sending-spinner-dots span:nth-child(3) {\n      animation-delay: 0.4s;\n      margin-right: 0;\n    }\n    \n    @keyframes ${t}-sending-pulse {\n      0%, 80%, 100% { transform: scale(0.8); opacity: 0.6; }\n      40% { transform: scale(1.2); opacity: 1; }\n    }\n    \n    /* Predefined questions */\n    .${t}-predefined-container {\n      display: flex;\n      flex-wrap: wrap;\n      gap: 8px;\n      padding: 10px 15px;\n    }\n    \n    .${t}-predefined-top {\n      border-bottom: 1px solid rgba(0,0,0,0.1);\n    }\n    \n    .${t}-predefined-bottom {\n      border-top: 1px solid rgba(0,0,0,0.1);\n    }\n    \n    .${t}-predefined-welcome {\n      margin-top: 5px;\n      margin-bottom: 10px;\n      background-color: rgba(0,0,0,0.02);\n      border-radius: 10px;\n    }\n    \n    .${t}-predefined-button {\n      border: none;\n      padding: 8px 16px;\n      font-size: ${n.predefinedQuestions.fontSize||"14px"};\n      cursor: pointer;\n      transition: background-color 0.2s;\n      ${n.predefinedQuestions.allowTextWrapping?"white-space: normal; word-wrap: break-word; overflow-wrap: break-word;":"white-space: nowrap; text-overflow: ellipsis; overflow: hidden; max-width: 200px;"} /* Truncate */\n      background-color: ${n.predefinedQuestions.buttonColor};\n      color: ${n.predefinedQuestions.textColor};\n    }\n    \n    .${t}-predefined-button:hover {\n      background-color: ${n.predefinedQuestions.hoverColor};\n    }\n    \n    .${t}-predefined-button {\n      border-radius: 16px;\n    }\n    \n    .${t}-predefined-pill {\n      border-radius: 24px;\n    }\n    \n    /* Powered by section */\n    .${t}-powered-by {\n      text-align: center;\n      font-size: 12px;\n      color: #9ca3af;\n      padding: 5px 0;\n      border-top: 1px solid #e5e7eb;\n    }\n    \n    .${t}-powered-by a {\n      color: ${s.primaryColor};\n      text-decoration: none;\n    }\n    \n    .${t}-powered-by a:hover {\n      text-decoration: underline;\n    }\n    \n    /* Markdown formatting for messages */\n    .${t}-message a {\n      color: ${s.primaryColor};\n      text-decoration: none;\n    }\n    .${t}-message a:hover {\n      text-decoration: underline;\n    }\n    .${t}-message code {\n      font-family: monospace;\n      background-color: rgba(0,0,0,0.05);\n      padding: 2px 4px;\n      border-radius: 4px;\n    }\n    .${t}-message pre {\n      background-color: rgba(0,0,0,0.05);\n      padding: 10px;\n      border-radius: 4px;\n      overflow-x: auto;\n    }\n    \n    /* Image formatting for messages */\n    .${t}-message img {\n      max-width: 100%;\n      height: auto;\n      border-radius: 4px;\n      margin: 4px 0;\n      display: block;\n    }\n    \n    /* Responsive styles for small screens (less than 800px width) */\n    @media (max-width: 800px) {\n      .${t}-panel {\n        width: calc(100% - 20px);\n        max-width: 100%;\n        right: 10px;\n        left: 10px;\n        height: 70vh;\n        max-height: 550px;\n        bottom: 70px;\n      }\n      \n      .${t}-button {\n        width: 50px;\n        height: 50px;\n        bottom: 10px;\n        right: 10px;\n      }\n      \n      .${t}-messages {\n        max-height: calc(70vh - 120px);\n      }\n      \n      .${t}-input-container {\n        padding: 8px;\n      }\n      \n      .${t}-input {\n        padding: 8px 12px;\n        font-size: 14px;\n      }\n      \n      .${t}-message-with-avatar {\n        max-width: 95%;\n      }\n      \n      .${t}-predefined-container {\n        padding: 8px;\n        gap: 5px;\n      }\n      \n      .${t}-predefined-button {\n        padding: 6px 12px;\n        font-size: 13px;\n      }\n    }\n  `,l=document.createElement("style");l.textContent=d,document.head.appendChild(l)}function i(e){const{streamState:n}=e;n.sendingSpinner&&n.sendingSpinner.parentNode&&(n.sendingSpinner.parentNode.removeChild(n.sendingSpinner),n.sendingSpinner=null)}function a(e){e&&"function"==typeof e.scrollIntoView&&e.scrollIntoView({behavior:"auto",block:"start"})}function o(e){const{elements:n}=e;n.chatMessages&&(n.chatMessages.scrollTop=n.chatMessages.scrollHeight)}window.DOMPurify||console.error("StreamingChatWidget requires DOMPurify. Please include it in your page."),window.marked||console.error("StreamingChatWidget requires marked.js. Please include it in your page.");class r{constructor(t){window.DOMPurify&&window.marked&&(t&&t.chatId?t.sessionEndpointUrl?t.backendStreamUrl?(this.config=n(e,t),this.sessionToken=null,this.assistantId=null,this.isSessionInitialized=!1,this.streamState={currentBotMessage:null,activeMessageContent:"",isStreaming:!1,typingIndicator:null,sendingSpinner:null},this.awaitingPotentialCacheEcho=!1,this.lastSentUserMessageText=null,this.elements={},this.namespace="sse-chat-"+Math.random().toString(36).substr(2,9),this.addMessage=this._addMessage.bind(this),this._updateStreamedMessage=this._updateStreamedMessage.bind(this),this._showTypingIndicator=this._showTypingIndicator.bind(this),this._removeTypingIndicator=this._removeTypingIndicator.bind(this),this._showSendingSpinner=this._showSendingSpinner.bind(this),this._removeSendingSpinner=this._removeSendingSpinner.bind(this),this._scrollToBottom=this._scrollToBottom.bind(this),this._handlePredefinedQuestion=this._handlePredefinedQuestion.bind(this),this._setupDependencies(),this._initUI()):console.error("StreamingChatWidget: backendStreamUrl is required."):console.error("StreamingChatWidget: sessionEndpointUrl is required."):console.error("StreamingChatWidget: chatId is required."))}_setupDependencies(){marked.setOptions({gfm:!0,breaks:!0,sanitize:!1,highlight:function(e,n){return e},renderer:new marked.Renderer})}_initUI(){!function(e){const{config:n,namespace:s,elements:i}=e,a=document.createElement("button");a.id=`${s}-button`,a.className=`${s}-button`,a.innerHTML=t(n.icons.chatButton),document.body.appendChild(a),i.chatButton=a;const o=document.createElement("div");o.id=`${s}-panel`,o.className=`${s}-panel`,document.body.appendChild(o),i.chatPanel=o;const r=document.createElement("div");r.className=`${s}-header`;const d=document.createElement("div");d.textContent=n.text.headerTitle;const l=document.createElement("div");l.className=`${s}-close`,l.innerHTML="&times;",r.appendChild(d),r.appendChild(l),o.appendChild(r),i.chatHeader=r,i.closeButton=l;const c=document.createElement("div");if(c.className=`${s}-messages`,o.appendChild(c),i.chatMessages=c,n.text.welcomeMessage){const e=document.createElement("div");e.className=`${s}-message-with-avatar ${s}-bot-message-container`;const i=document.createElement("div");i.className=`${s}-avatar ${s}-bot-avatar`,i.innerHTML=t(n.icons.botAvatar);const a=document.createElement("div");a.className=`${s}-message ${s}-bot-message`,a.textContent=n.text.welcomeMessage,e.appendChild(i),e.appendChild(a),c.appendChild(e)}const p=document.createElement("div");p.className=`${s}-input-container`;const h=document.createElement("input");h.type="text",h.className=`${s}-input`,h.placeholder=n.text.inputPlaceholder;const g=document.createElement("button");g.className=`${s}-send-button`,g.innerHTML=t(n.icons.sendButton),p.appendChild(h),p.appendChild(g),o.appendChild(p);const u=document.createElement("div");u.className=`${s}-powered-by`,u.innerHTML='powered by <a href="https://www.fxrsoft.com" target="_blank">fxrsoft</a>',o.appendChild(u),i.inputContainer=p,i.chatInput=h,i.sendButton=g,i.poweredBy=u}(this),s(this),function(e){const{elements:n,toggleChat:t,hideChat:s,sendMessage:i}=e;n.chatButton.addEventListener("click",(()=>{t.call(e)})),n.closeButton.addEventListener("click",(()=>{s.call(e)})),n.sendButton.addEventListener("click",(()=>{i.call(e)})),n.chatInput.addEventListener("keypress",(n=>{"Enter"===n.key&&i.call(e)}))}(this),this.config.predefinedQuestions.enabled&&function(e){const{config:n,namespace:t,elements:s,_handlePredefinedQuestion:i}=e;if(!n.predefinedQuestions.enabled||!n.predefinedQuestions.questions||0===n.predefinedQuestions.questions.length)return;const a=document.createElement("div");if(a.className=`${t}-predefined-container`,a.classList.add(`${t}-predefined-${n.predefinedQuestions.position}`),n.predefinedQuestions.questions.forEach((s=>{const i=document.createElement("button");i.className=`${t}-predefined-button`,i.classList.add(`${t}-predefined-${n.predefinedQuestions.style}`);const o=s.text&&"object"==typeof s.text?"":String(s.text||"");i.textContent=o,i.addEventListener("click",(()=>{let n=s.value||s.text;"object"==typeof n&&(n=o),e._handlePredefinedQuestion(n)})),a.appendChild(i)})),"top"===n.predefinedQuestions.position)s.chatMessages.insertBefore(a,s.chatMessages.firstChild);else if("bottom"===n.predefinedQuestions.position)s.chatPanel.insertBefore(a,s.inputContainer);else if("welcome"===n.predefinedQuestions.position){a.classList.remove(`${t}-predefined-welcome`),a.classList.add(`${t}-predefined-top`),s.chatMessages.insertBefore(a,s.chatMessages.firstChild);const e=s.chatMessages.querySelector(`.${t}-bot-message-container`);e&&(a.classList.remove(`${t}-predefined-top`),a.classList.add(`${t}-predefined-welcome`),s.chatMessages.insertBefore(a,e.nextSibling))}s.predefinedContainer=a}(this)}_addMessage(e,n){return function(e,n,s){const{config:i,namespace:o,elements:r}=e;let d;if(r.chatMessages){if("system"===n){const e=document.createElement("div");e.className=`${o}-system-message`,e.textContent=s,r.chatMessages.appendChild(e),d=e,"Initializing chat session..."!==s&&"Chat session started."!==s&&"Initializing session before sending..."!==s||setTimeout((()=>{e&&e.parentNode&&e.parentNode.removeChild(e)}),3e3)}else if("user"===n){const e=document.createElement("div");e.className=`${o}-message-with-avatar ${o}-user-message-container`;const n=document.createElement("div");n.className=`${o}-avatar ${o}-user-avatar`,n.innerHTML=t(i.icons.userAvatar);const a=document.createElement("div");a.className=`${o}-message ${o}-user-message`,a.textContent=s,e.appendChild(n),e.appendChild(a),r.chatMessages.appendChild(e),d=e}else if("bot"===n){const e=document.createElement("div");e.className=`${o}-message-with-avatar ${o}-bot-message-container`;const n=document.createElement("div");n.className=`${o}-avatar ${o}-bot-avatar`,n.innerHTML=t(i.icons.botAvatar);const a=document.createElement("div");a.className=`${o}-message ${o}-bot-message`;let l=marked.parse(s||"");const c=document.createElement("div");c.innerHTML=l,c.querySelectorAll("img").forEach((e=>{const n=e.getAttribute("title");if(n){const t=/style="([^"]*)"/,s=n.match(t);if(s&&s[1]){const i=s[1];e.style.cssText=e.style.cssText?e.style.cssText.replace(/;$/,"")+";"+i:i;let a=n.replace(t,"").replace(/\s*\/[\s)]*$/,"").trim();a?e.setAttribute("title",a):e.removeAttribute("title")}}})),l=c.innerHTML,i.sanitization.output?a.innerHTML=DOMPurify.sanitize(l,{ADD_TAGS:["iframe","video","source"],ALLOW_TAGS:["b","i","em","strong","a","p","ul","ol","li","br","img","pre","code","blockquote","h1","h2","h3","h4","h5","h6","hr","span"],ALLOW_ATTR:["href","src","alt","title","target","rel","class","style","controls","autoplay","loop","muted","poster","preload","width","height","type","frameborder","allowfullscreen","allow"],ADD_ATTR:["target","rel"]}):a.innerHTML=l;const p=document.createElement("div");p.innerHTML=a.innerHTML,p.querySelectorAll("a").forEach((e=>{try{const n=new URL(e.href);let t=null;if("www.youtube.com"===n.hostname||"youtube.com"===n.hostname?"/watch"===n.pathname?t=n.searchParams.get("v"):n.pathname.startsWith("/embed/")&&(t=n.pathname.substring(7)):"youtu.be"===n.hostname&&(t=n.pathname.substring(1)),t){const n=document.createElement("iframe");n.setAttribute("src",`https://www.youtube.com/embed/${t}`),n.setAttribute("width","100%");const s=a.offsetWidth||300;n.setAttribute("height",`${Math.round(9*s/16)}`),n.setAttribute("frameborder","0"),n.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"),n.setAttribute("allowfullscreen",""),e.parentNode&&e.parentNode!==p?e.parentNode.replaceChild(n,e):e.parentNode===p&&p.replaceChild(n,e)}}catch(n){console.warn("Could not process link for YouTube embed (initial):",e.href,n)}})),a.innerHTML=p.innerHTML,e.appendChild(n),e.appendChild(a),r.chatMessages.appendChild(e),d=e}a(d)}}(this,e,n)}_updateStreamedMessage(e){!function(e,n){const{config:t,streamState:s,namespace:i,elements:o}=e;if(!s.currentBotMessage&&o.chatMessages){e.addMessage("bot","");const n=o.chatMessages.querySelector(`.${i}-bot-message-container:last-child`);console.log("[uiManager] lastBotMessageContainer:",n),n&&(s.currentBotMessage=n.querySelector(`.${i}-bot-message`),console.log("[uiManager] streamState.currentBotMessage SET:",s.currentBotMessage))}if(s.currentBotMessage&&n){s.activeMessageContent+=n;let e=marked.parse(s.activeMessageContent);const i=document.createElement("div");i.innerHTML=e,i.querySelectorAll("img").forEach((e=>{const n=e.getAttribute("title");if(n){const t=/style="([^"]*)"/,s=n.match(t);if(s&&s[1]){const i=s[1];e.style.cssText=e.style.cssText?e.style.cssText.replace(/;$/,"")+";"+i:i;let a=n.replace(t,"").replace(/\s*\/[\s)]*$/,"").trim();a?e.setAttribute("title",a):e.removeAttribute("title")}}})),e=i.innerHTML,t.sanitization.output?s.currentBotMessage.innerHTML=DOMPurify.sanitize(e,{ADD_TAGS:["iframe","video","source"],ALLOW_TAGS:["b","i","em","strong","a","p","ul","ol","li","br","img","pre","code","blockquote","h1","h2","h3","h4","h5","h6","hr","span"],ALLOW_ATTR:["href","src","alt","title","target","rel","class","style","controls","autoplay","loop","muted","poster","preload","width","height","type","frameborder","allowfullscreen","allow"],ADD_ATTR:["target","rel"]}):s.currentBotMessage.innerHTML=e;const o=document.createElement("div");o.innerHTML=s.currentBotMessage.innerHTML,o.querySelectorAll("a").forEach((e=>{try{const n=new URL(e.href);let t=null;if("www.youtube.com"===n.hostname||"youtube.com"===n.hostname?"/watch"===n.pathname?t=n.searchParams.get("v"):n.pathname.startsWith("/embed/")&&(t=n.pathname.substring(7)):"youtu.be"===n.hostname&&(t=n.pathname.substring(1)),t){const n=document.createElement("iframe");n.setAttribute("src",`https://www.youtube.com/embed/${t}`),n.setAttribute("width","100%");const i=s.currentBotMessage.offsetWidth||300;n.setAttribute("height",`${Math.round(9*i/16)}`),n.setAttribute("frameborder","0"),n.setAttribute("allow","accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"),n.setAttribute("allowfullscreen",""),e.parentNode&&e.parentNode!==o?e.parentNode.replaceChild(n,e):e.parentNode===o&&o.replaceChild(n,e)}}catch(n){console.warn("Could not process link for YouTube embed (incremental):",e.href,n)}})),s.currentBotMessage.innerHTML=o.innerHTML,s.currentBotMessage&&a(s.currentBotMessage)}}(this,e)}_showTypingIndicator(){!function(e){const{namespace:n,elements:t,streamState:s}=e;if(s.typingIndicator&&s.typingIndicator.parentNode)return;const i=document.createElement("div");i.className=`${n}-typing-indicator`;for(let a=0;a<3;a++){const e=document.createElement("span");i.appendChild(e)}t.chatMessages.appendChild(i),s.typingIndicator=i,o(e)}(this)}_removeTypingIndicator(){!function(e){const{streamState:n}=e;n.typingIndicator&&n.typingIndicator.parentNode&&(n.typingIndicator.parentNode.removeChild(n.typingIndicator),n.typingIndicator=null)}(this)}_showSendingSpinner(){!function(e){const{namespace:n,elements:t,streamState:s}=e;i(e);const a=document.createElement("div");a.className=`${n}-sending-spinner`;const o=document.createElement("div");o.className=`${n}-sending-spinner-dots`;for(let i=0;i<3;i++){const e=document.createElement("span");o.appendChild(e)}a.appendChild(o),t.chatMessages.appendChild(a),s.sendingSpinner=a,setTimeout((()=>{a&&a.parentNode&&a.classList.add(`${n}-active`)}),10)}(this)}_removeSendingSpinner(){i(this)}_scrollToBottom(){o(this)}async _handlePredefinedQuestion(e){await async function(e,n){const{config:t,elements:s,sendMessage:i}=e,a="object"==typeof n?n.toString&&"[object Object]"!==n.toString()?n.toString():"":String(n||"");await i.call(e,a),t.predefinedQuestions.hideAfterSelection&&s.predefinedContainer&&(s.predefinedContainer.style.display="none")}(this,e)}async initSession(){const{config:e}=this;if(!this.isSessionInitialized){if(!e.chatId||!e.sessionEndpointUrl)return console.error("StreamingChatWidget: Cannot init session. Missing chatId or sessionEndpointUrl in config."),void this.addMessage("system","Chat initialization failed: Configuration error.");try{const n=await fetch(e.sessionEndpointUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({chatid:e.chatId})});if(!n.ok){const e=await n.json().catch((()=>({detail:n.statusText})));throw new Error(e.detail||`HTTP error ${n.status}`)}const t=await n.json();this.sessionToken=t.session_token,this.assistantId=t.assistant_id,this.isSessionInitialized=!0}catch(n){console.error("Error initiating chat session:",n),this.addMessage("system","Failed to start chat session: "+n.message),this.isSessionInitialized=!1}}}_handleStreamEvent(e,n){const{streamState:t,addMessage:s,_updateStreamedMessage:i,_removeTypingIndicator:a}=this;"thread.message.delta"===e&&"text_delta"===n.type?n.content&&i(n.content):"thread.run.completed"===e?(t.isStreaming=!1,a(),t.currentBotMessage=null,t.activeMessageContent="",this.awaitingPotentialCacheEcho=!1,null!==this.lastSentUserMessageText&&(this.lastSentUserMessageText=null)):"thread.run.failed"===e||"error"===e?(s("system",`Error: ${n.error||n.detail||"An unknown error occurred."}`),t.isStreaming=!1,a(),t.currentBotMessage=null,t.activeMessageContent="",this.awaitingPotentialCacheEcho=!1,null!==this.lastSentUserMessageText&&(this.lastSentUserMessageText=null)):"stream_end"===e&&(t.isStreaming=!1,a(),t.currentBotMessage=null,t.activeMessageContent="",this.awaitingPotentialCacheEcho=!1,null!==this.lastSentUserMessageText&&(this.lastSentUserMessageText=null))}async _streamResponseFromServer(e){const{config:n,streamState:t,sessionToken:s,isSessionInitialized:i,addMessage:a,_removeSendingSpinner:o,_showTypingIndicator:r,_removeTypingIndicator:d}=this;if(!i||!s)return a("system","Session not initialized. Please try again."),void o();if(!n.backendStreamUrl)return a("system","Chat stream endpoint not configured."),void o();t.isStreaming=!0,t.activeMessageContent="",t.currentBotMessage=null;try{const i=await fetch(n.backendStreamUrl,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({session_token:s,message:e})});if(o(),!i.ok||!i.body){return a("system",`Error: ${(await i.json().catch((()=>({detail:i.statusText})))).detail||"Failed to connect to stream"}`),void(t.isStreaming=!1)}r();const d=i.body.getReader(),c=new TextDecoder;let p="";for(;;){const{value:e,done:n}=await d.read();if(n){if(p.trim().length>0){p.endsWith("\n\n")||(p+="\n\n");let e=p.indexOf("\n\n");for(;-1!==e;){const n=p.substring(0,e);p=p.substring(e+2);let t="message",s=[];n.split("\n").forEach((e=>{e.startsWith("event:")?t=e.substring(6).trim():e.startsWith("data:")&&s.push(e.substring(5).trim())}));const i=s.join("");if(i)try{const e=JSON.parse(i);this._handleStreamEvent(t,e)}catch(l){console.error("Error parsing final buffer SSE data:",i,l)}e=p.indexOf("\n\n")}}t.isStreaming&&this._handleStreamEvent("stream_end",{message:"Stream closed by server (final processing complete)."});break}p+=c.decode(e,{stream:!0});let s=p.indexOf("\n\n");for(;-1!==s;){const e=p.substring(0,s);p=p.substring(s+2);let n="message",t=[];e.split("\n").forEach((e=>{e.startsWith("event:")?n=e.substring(6).trim():e.startsWith("data:")&&t.push(e.substring(5).trim())}));const i=t.join("");if(i)try{const e=JSON.parse(i);if("cached_message"===n){if(e.role&&e.content){const n="assistant"===e.role?"bot":"user"===e.role?"user":e.role;let t=!0;this.awaitingPotentialCacheEcho&&"user"===n&&e.content===this.lastSentUserMessageText&&(t=!1,this.lastSentUserMessageText=null),t&&a(n,e.content)}}else this._handleStreamEvent(n,e)}catch(l){console.error("Error parsing SSE data:",i,l)}s=p.indexOf("\n\n")}}}catch(c){console.error("Streaming fetch error:",c),a("system","Connection error during streaming."),t.isStreaming=!1,d(),o()}}async sendMessage(e){let n=e;if(void 0===n){if(n=this.elements.chatInput.value.trim(),!n)return;this.elements.chatInput.value=""}if(this.addMessage("user",n),this.awaitingPotentialCacheEcho=!0,this.lastSentUserMessageText=n,!this.isSessionInitialized&&(await this.initSession(),!this.isSessionInitialized))return this.addMessage("system","Session initialization failed. Cannot send message."),this.awaitingPotentialCacheEcho=!1,this.lastSentUserMessageText=null,void this._removeSendingSpinner();this._showSendingSpinner(),this._streamResponseFromServer(n)}toggleChat(){"flex"===this.elements.chatPanel.style.display?this.hideChat():this.showChat()}showChat(){this.elements.chatPanel.style.display="flex",setTimeout((()=>{this.elements.chatInput&&this.elements.chatInput.focus()}),100),this._scrollToBottom()}hideChat(){this.elements.chatPanel.style.display="none"}destroy(){this.elements&&"object"==typeof this.elements&&(Object.values(this.elements).forEach((e=>{e&&e.parentNode&&e.parentNode.removeChild(e)})),this.elements={});document.querySelectorAll("style").forEach((e=>{e.textContent&&e.textContent.includes(this.namespace)&&e.parentNode&&e.parentNode.removeChild(e)})),this.streamState={currentBotMessage:null,activeMessageContent:"",isStreaming:!1,typingIndicator:null,sendingSpinner:null}}on(e,n){console.log(`Event '${e}' registered but handling not implemented yet`)}}return"undefined"!=typeof window&&(window.StreamingChatWidget=r),r}));
